# Vibe Kanban MCP Extension - Progress Log

Branch: vk-mcp-lifecycle
Started: 2026-01-23

---

## Codebase Patterns
- Use `ApiError::NotFound(message)` for 404 responses in API routes
- Workspace diff stats: reuse `compute_workspace_diff_stats` pattern from `workspace_summary.rs`
- Use `ExecutionProcess::find_latest_by_workspace_and_run_reason` to get latest execution status
- Routes are registered in `crates/server/src/routes/mod.rs` via `.merge()` or `.nest()`
- New route modules should follow existing patterns (axum handlers with `State<DeploymentImpl>`)
- MCP tools: use `#[tool(description = "...")]` macro in `#[tool_router] impl TaskServer` block
- MCP request structs: `#[derive(Debug, Deserialize, schemars::JsonSchema)]` with `#[schemars(description)]`
- MCP response structs: `#[derive(Debug, Serialize, Deserialize, schemars::JsonSchema)]`
- MCP tools call internal API via `self.send_json(self.client.get(&url))` pattern

---

## Story Progress

## 2026-01-23 - US-001
- What was implemented:
  - Added GET /api/workspaces/{id}/status route in crates/server/src/routes/workspaces.rs
  - Returns workspace_id, status (running/completed/failed/killed/none), diff stats
  - Added NotFound variant to ApiError for proper 404 handling
- Files changed:
  - crates/server/src/routes/workspaces.rs (new)
  - crates/server/src/routes/mod.rs (added workspaces module + route)
  - crates/server/src/error.rs (added NotFound variant)
- **Learnings for future iterations:**
  - ApiError didn't have a NotFound variant - added it to support 404 responses
  - Diff stats computation uses spawn_blocking for git operations (blocking I/O)
  - Routes nested under /api/workspaces are separate from /api/task-attempts (which also deals with workspaces)
---

## 2026-01-23 - US-002
- What was implemented:
  - Added `GetWorkspaceStatusRequest` struct with `workspace_id: Uuid`
  - Added `GetWorkspaceStatusResponse` struct with status, diff stats fields
  - Added `get_workspace_status` tool in `#[tool_router] impl TaskServer` block
  - Tool calls `/api/workspaces/{id}/status` via `self.client`
- Files changed:
  - crates/server/src/mcp/task_server.rs (added request/response structs + tool method)
- **Learnings for future iterations:**
  - MCP tools follow a consistent pattern: request struct → response struct → tool method
  - Response structs need both `Serialize` and `Deserialize` since they're parsed from API response
  - Use `#[schemars(description = "...")]` on each field for MCP schema generation
  - Tools are added inside the `#[tool_router] impl TaskServer` block, not a separate impl
---

## 2026-01-23 - US-003
- What was implemented:
  - Added GET /api/workspaces/{id}/transcript route in crates/server/src/routes/workspaces.rs
  - Added `find_latest_by_workspace_id` method to CodingAgentTurn model
  - Returns workspace_id, prompt, summary, agent_session_id from latest coding agent turn
  - Returns 404 if workspace not found
  - Returns empty/null fields if no coding agent turns exist
- Files changed:
  - crates/server/src/routes/workspaces.rs (added WorkspaceTranscriptResponse + get_workspace_transcript handler)
  - crates/db/src/models/coding_agent_turn.rs (added find_latest_by_workspace_id method)
  - crates/db/.sqlx/ (new query cache file)
- **Learnings for future iterations:**
  - Query for workspace-related coding agent turns requires joining sessions → execution_processes → coding_agent_turns
  - Use `ep.run_reason = 'codingagent'` and `ep.dropped = 0` to filter for valid coding agent executions
  - After adding new SQLx queries, run `pnpm run prepare-db` to update the query cache
---

## 2026-01-23 - US-004
- What was implemented:
  - Added `GetWorkspaceTranscriptRequest` struct with `workspace_id: Uuid`
  - Added `GetWorkspaceTranscriptResponse` struct with prompt, summary, agent_session_id
  - Added `get_workspace_transcript` tool in `#[tool_router] impl TaskServer` block
  - Tool calls `/api/workspaces/{id}/transcript` via `self.client`
- Files changed:
  - crates/server/src/mcp/task_server.rs (added request/response structs + tool method)
- **Learnings for future iterations:**
  - MCP transcript tool mirrors the status tool pattern exactly
  - Both tools follow: request struct → response struct → tool calling API route
---

## 2026-01-23 - US-005
- What was implemented:
  - Added GET /api/workspaces/{id}/diff route in crates/server/src/routes/workspaces.rs
  - Returns list of files with: path, additions, deletions, diff_content (unified diff format)
  - Uses `git.get_diffs()` to get file contents, `create_unified_diff()` for diff format
  - Compares workspace branch to target branch via merge base
  - Returns 404 if workspace not found or no container_ref
- Files changed:
  - crates/server/src/routes/workspaces.rs (added FileDiff, WorkspaceDiffResponse, get_workspace_diff)
- **Learnings for future iterations:**
  - `Diff` struct from utils/diff.rs contains old_content/new_content for computing unified diff
  - Use `create_unified_diff(path, old, new)` from utils::diff for unified diff output
  - Handle `content_omitted` flag for large files
---

## 2026-01-23 - US-006
- What was implemented:
  - Added `GetWorkspaceDiffRequest` struct with `workspace_id: Uuid`
  - Added `GetWorkspaceDiffResponse` struct with list of file diffs
  - Added `FileDiffInfo` struct with path, additions, deletions, diff_content
  - Added `get_workspace_diff` tool in `#[tool_router] impl TaskServer` block
  - Tool calls `/api/workspaces/{id}/diff` via `self.client`
- Files changed:
  - crates/server/src/mcp/task_server.rs (added request/response/file structs + tool method)
- **Learnings for future iterations:**
  - MCP diff tool follows same pattern as status/transcript tools
  - FileDiffInfo mirrors the API response structure for seamless JSON parsing
---

## 2026-01-23 - US-007
- What was implemented:
  - Added `delete_branch` method to GitCli (git branch -D)
  - Added `delete_branch` method to GitService (wraps GitCli)
  - Added `close_workspace_discard` function to WorkspaceManager
  - Function cleans up worktrees via existing cleanup_workspace()
  - Function deletes workspace branch from each repository
  - Database operations (archived, container_ref, running process check) delegated to caller
- Files changed:
  - crates/services/src/services/git/cli.rs (added delete_branch)
  - crates/services/src/services/git.rs (added delete_branch wrapper)
  - crates/services/src/services/workspace_manager.rs (added close_workspace_discard)
- **Learnings for future iterations:**
  - WorkspaceManager doesn't have database access - db operations handled at route level
  - Branch deletion failures are logged but don't fail the close operation (branch might already be gone)
  - Use `-D` (force delete) for workspace branches since they may have unmerged commits
---

## 2026-01-23 - US-008
- What was implemented:
  - Added `merge_commit` method to GitCli (git merge --no-ff)
  - Added `merge_into_branch` method to GitService with conflict detection
  - Added `close_workspace_merge` function to WorkspaceManager
  - Added `RepoMergeResult` struct for merge results
  - Added `MergeConflicts` error variant to WorkspaceError
  - Returns merge commit SHA for each repo on success
  - Database operations (create DirectMerge, call discard) handled by caller
- Files changed:
  - crates/services/src/services/git/cli.rs (added merge_commit)
  - crates/services/src/services/git.rs (added merge_into_branch)
  - crates/services/src/services/workspace_manager.rs (added close_workspace_merge, RepoMergeResult, MergeConflicts)
- **Learnings for future iterations:**
  - Use `--no-ff` for merge to always create a merge commit (makes history clearer)
  - Merge conflicts detected by checking error message for "CONFLICT" keyword
  - Merge operations run in main repo directory, not worktree
---

## 2026-01-23 - US-009
- What was implemented:
  - Added POST /api/workspaces/{id}/close route in crates/server/src/routes/workspaces.rs
  - Accepts JSON body with strategy: 'merge' | 'discard'
  - Validates workspace exists and has container_ref (returns 400 if already closed)
  - Checks for running processes before closing (returns 400 if processes running)
  - For merge: calls WorkspaceManager::close_workspace_merge, creates DirectMerge records, then cleanup
  - For discard: calls WorkspaceManager::close_workspace_discard directly
  - Returns 409 Conflict on merge conflicts with descriptive message
  - Updates database: sets archived=true, clears container_ref
- Files changed:
  - crates/server/src/routes/workspaces.rs (added CloseWorkspaceRequest, CloseWorkspaceResponse, close_workspace handler)
- **Learnings for future iterations:**
  - ApiError doesn't have an `Internal` variant - use `BadRequest` for general error messages
  - Use `ApiError::Conflict(message)` for 409 responses on merge conflicts
  - `ExecutionProcess::has_running_non_dev_server_processes_for_workspace` checks if workspace has running processes
  - `Workspace::set_archived` and `Workspace::clear_container_ref` are separate db operations
---

## 2026-01-23 - US-010
- What was implemented:
  - Added `CloseWorkspaceRequest` struct with workspace_id: Uuid, strategy: String
  - Added `CloseWorkspaceResponse` struct with workspace_id, success, message, merge_commit_sha
  - Added `close_workspace` tool in `#[tool_router] impl TaskServer` block
  - Tool validates strategy is 'merge' or 'discard' before calling API
  - Tool calls `/api/workspaces/{id}/close` via `self.client.post().json()`
- Files changed:
  - crates/server/src/mcp/task_server.rs (added request/response structs + tool method)
- **Learnings for future iterations:**
  - For POST requests with JSON body, use `self.client.post(&url).json(&body)`
  - Use `Self::err(message, None::<String>)` for returning tool errors
  - MCP tool can do early validation before calling API for better error messages
---
